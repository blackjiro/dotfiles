---
allowed-tools: Bash(*), Read(*), Write(*), Edit(*), Grep(*), Glob(*), TodoWrite(*), TodoRead(*)
description: "TDDで最新のPLAN.mdまたはSCRATCHPAD.mdからタスクを実行"
---

# TDD Execute Plan

最新のPLAN.mdまたはSCRATCHPAD.mdファイルを見つけて、記載されているタスクをTDD方式で実行します。

## Instructions

1. **計画ドキュメントの検索**
   - 現在のディレクトリとサブディレクトリからPLAN.mdまたはSCRATCHPAD.mdを検索
   - 複数見つかった場合は最新のものを使用
   - 見つからない場合はホームディレクトリも検索

2. **タスクの抽出と解析**
   - 見つかったドキュメントを読み込む
   - TODOリスト、タスクリスト、または番号付きリストを抽出
   - タスクの優先順位を判定

3. **TDD実行サイクル**
   各タスクに対して：
   - **Red**: 失敗するテストを作成
   - **Green**: テストが通る最小限の実装
   - **Refactor**: コードの改善とクリーンアップ

4. **進捗管理**
   - TodoWriteツールで各タスクの進捗を管理
   - 完了したタスクにチェックマークを付ける
   - 実行結果をドキュメントに記録
   - **重要**: タスクが完了したら、PLAN.mdまたはSCRATCHPAD.md内のチェックリストを更新
     - [ ] → [x] に変更して完了状態を反映
     - 完了した項目の詳細や結果をドキュメントに追記

5. **完了確認**
   - すべてのテストが通ることを確認
   - lintとtypecheckを実行
   - 実行結果のサマリーを表示

6. **品質保証サブタスク (完了後必須)**
   全てのタスクが完了した後、以下の品質保証サブタスクを**必ず**実行する：
   
   **重要**: この品質保証サブタスクは、メインタスクの完了後に独立したサブタスクとして起動し、
   全ての検証が完了するまで本コマンドは終了しない。
   
   **6.1 Lint検証**
   - プロジェクトで使用されているlintツールを自動検出
   - 全ファイルでlintエラーがないことを確認
   - lintエラーがある場合は修正してから次のステップへ
   
   **6.2 テスト検証**
   - 全てのテストが正常に実行できることを確認
   - テストカバレッジの確認
   - 失敗したテストがある場合は原因を特定し修正
   
   **6.3 PLAN.md仕様準拠検証**
   - 元のPLAN.mdまたはSCRATCHPAD.mdの仕様と実装を比較
   - 各要求事項が実装されていることを確認
   - 仕様から逸脱している部分がないか検証
   - 実装が仕様の意図通りに動作するか確認
   
   **6.4 テスト完全性検証**
   - テストが無理やり通るように仕様変更されていないか確認
   - skipされているテストがないか確認
   - テストが実際の機能をカバーしているか確認
   - テストダブルやモックが適切に使用されているか確認
   
   **6.5 最終レポート**
   - 全ての検証結果をまとめたレポートを作成
   - 発見された問題点とその修正結果を記録
   - 品質基準を満たしているか最終判定

## 品質保証サブタスクの実行詳細

### 6.1 Lint検証の実行方法
- プロジェクトディレクトリから設定ファイルを検索してlintツールを自動検出
- package.json, pyproject.toml, Gemfile等からlintコマンドを特定
- 検出されたlintツールを実行し、エラーがないことを確認
- 複数のlintツールが存在する場合はすべて実行

### 6.2 テスト検証の実行方法
- プロジェクトディレクトリから設定ファイルを検索してテストランナーを自動検出
- package.json, pytest.ini, Makefile等からテストコマンドを特定
- 検出されたテストランナーを実行し、全テストが成功することを確認
- テストカバレッジが設定されている場合は併せて実行

### 6.3 仕様準拠検証のポイント
- PLAN.mdの各セクションと実装されたファイルを対照
- 機能要件、非機能要件、制約事項の実装状況を確認
- APIの仕様（引数、戻り値、エラーハンドリング）が一致しているか
- ユーザーインターフェースの仕様通りの動作を確認

### 6.4 テスト完全性検証のチェック項目
- `skip`、`xfail`、`pending`などのマークがされたテストの確認
- テストカバレッジレポートの生成と分析
- モックやスタブが本来の機能を隠蔽していないか確認
- テストデータが現実的で適切か確認

## Error Handling

- 計画ドキュメントが見つからない場合は、ユーザーに作成を促す
- テスト実行に失敗した場合は、エラー内容を分析して修正案を提示
- 依存関係の問題がある場合は、必要なパッケージのインストールを提案
- **品質保証サブタスクでの新しいエラーハンドリング**:
  - Lintエラーが発生した場合は、自動修正を試みてから手動修正の指示
  - テスト失敗時は、失敗の原因を特定し仕様の再確認を実施
  - 仕様準拠検証で不整合が発見された場合は、ユーザーに確認を求める
  - テスト完全性に問題がある場合は、修正が必要な箇所を明確に指摘

## 実行フロー

1. PLAN.mdまたはSCRATCHPAD.mdの検索と読み込み
2. タスクの抽出と優先順位付け
3. 各タスクのTDDサイクル実行（Red-Green-Refactor）
4. 進捗管理とドキュメント更新
5. 基本的な完了確認（テスト・lint・typecheck）
6. **品質保証サブタスクの強制実行**（この段階で独立したサブタスクを起動）
7. 最終レポートの生成とコマンド終了

**重要**: 品質保証サブタスクは必須であり、省略できません。
全ての検証が完了し、品質基準を満たした場合のみコマンドが正常終了します。

## Usage Example

```
/dev:tdd-execute
```

このコマンドは自動的に最新の計画ドキュメントを見つけて、TDD方式でタスクを実行し、
完了後に品質保証サブタスクを必ず実行します。