---
allowed-tools: ["Bash", "Read", "Write", "Edit", "TodoWrite", "TodoRead", "Grep", "Glob"]
description: "PRのコミット履歴を分析し、論理的な単位を提案してからクリーンアップ"
---

# Clean Commits

PRのコミット履歴を整理する際、まず変更内容を分析し、論理的な分割単位を提案してから実行します。

## ワークフロー

### Phase 1: 変更の全体把握

1. **現在のブランチとベースブランチの特定**
   ```bash
   # 現在のブランチ名を取得
   git branch --show-current
   
   # ベースブランチを特定（通常はmain/masterまたはPRのターゲット）
   git merge-base HEAD origin/main
   ```

2. **全体の変更内容を分析**
   ```bash
   # ベースブランチからの全変更を確認
   git diff --stat $(git merge-base HEAD origin/main)..HEAD
   
   # ファイルごとの詳細な変更
   git diff $(git merge-base HEAD origin/main)..HEAD
   
   # 現在のコミット履歴
   git log --oneline $(git merge-base HEAD origin/main)..HEAD
   ```

3. **変更の種類を分類**
   - 機能追加
   - バグ修正
   - リファクタリング
   - ドキュメント更新
   - テストの追加/更新
   - 依存関係の更新
   - 設定変更

### Phase 2: コミット分割の提案

変更内容を分析した後、以下の形式で分割案を提示します：

```markdown
## コミット分割提案

現在のブランチには以下の変更が含まれています：
[変更の要約]

### 提案するコミット構成：

1. **[コミットタイトル案]**
   - 変更内容: [具体的な変更の説明]
   - 影響ファイル: [ファイルリスト]
   - 理由: [なぜこの単位でまとめるか]

2. **[コミットタイトル案]**
   - 変更内容: [具体的な変更の説明]
   - 影響ファイル: [ファイルリスト]
   - 理由: [なぜこの単位でまとめるか]

[必要に応じて追加]

この分割案でよろしいですか？ (Yes/No/修正案を提示)
```

### Phase 3: 承認後の実行

ユーザーの承認を得た後：

1. **作業ブランチのバックアップ**
   ```bash
   git branch backup/original-$(date +%Y%m%d-%H%M%S)
   ```

2. **インタラクティブリベースの実行**
   ```bash
   git rebase -i $(git merge-base HEAD origin/main)
   ```

3. **提案に従ってコミットを再構成**
   - 関連する変更をまとめる
   - 明確なコミットメッセージを作成
   - 各コミットが独立して動作することを確認

4. **最終確認**
   ```bash
   # 新しいコミット履歴を表示
   git log --oneline --graph $(git merge-base HEAD origin/main)..HEAD
   
   # 各コミットの内容を確認
   git show --stat HEAD~n..HEAD~(n-1)  # 各コミットについて
   ```

## ガイドライン

### コミット分割の原則
- **原子性**: 各コミットは1つの論理的な変更を表す
- **独立性**: 各コミットは独立してビルド/テストが通る
- **追跡可能性**: コミットメッセージは変更の理由を明確に説明
- **最小性**: 不要な分割は避ける（変更が少ない場合は無理に分割しない）

### コミットメッセージの形式
```
<type>(<scope>): <subject>

<body>

<footer>
```

- **type**: feat, fix, docs, style, refactor, test, chore
- **scope**: 影響を受けるモジュール/機能
- **subject**: 変更の簡潔な説明（50文字以内）
- **body**: 詳細な説明（なぜこの変更が必要か）
- **footer**: Breaking changes, Issues closed等

### 注意事項
- リベース前は必ずバックアップブランチを作成
- force pushが必要になる場合は事前に警告
- 共有ブランチでの作業時は特に注意
- コンフリクトが発生した場合は解決方法を提示

## エラーハンドリング

1. **リベース中のコンフリクト**
   - コンフリクトの内容を表示
   - 解決方法を提案
   - 必要に応じてリベースを中止（git rebase --abort）

2. **テスト失敗**
   - 失敗したコミットを特定
   - 修正方法を提案
   - 必要に応じて分割を再検討

3. **予期しない変更**
   - バックアップブランチから復元可能
   - 変更内容を再確認して提案を修正