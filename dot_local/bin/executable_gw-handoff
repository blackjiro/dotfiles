#!/bin/bash
# gw-handoff: Create worktree in new Zellij pane
# Usage: gw-handoff <branch-name> [-c|--from-current]

set -euo pipefail

BRANCH_NAME="${1:-}"
FROM_CURRENT=""

# Parse arguments
shift || true
while [[ $# -gt 0 ]]; do
    case "$1" in
        -c|--from-current)
            FROM_CURRENT="-c"
            shift
            ;;
        *)
            shift
            ;;
    esac
done

if [[ -z "$BRANCH_NAME" ]]; then
    echo "Usage: gw-handoff <branch-name> [-c|--from-current]"
    exit 1
fi

# Check if zellij is available
if ! command -v zellij &>/dev/null; then
    echo "Error: zellij is not installed or not in PATH" >&2
    exit 1
fi

# Check if we're in a zellij session
if [[ -z "${ZELLIJ:-}" ]]; then
    echo "Error: Must be run inside a zellij session" >&2
    exit 1
fi

# 新ペインで gw new --carry を実行し、その後 claude --resume（失敗しても継続）
# --carry: 未コミットの変更を新しい worktree に引き継ぐ
zellij run --direction right -- fish -c "gw new $FROM_CURRENT --carry '$BRANCH_NAME'; and begin; claude --resume; or true; end"
